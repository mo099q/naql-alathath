name: Auto Build All iOS Apps

on:
  push:
    branches: [ main ]

jobs:
  build_apps:
    runs-on: macos-latest

    strategy:
      matrix:
        app: [customer_app, driver_app, admin_panel]

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.13.0'

      - name: Prepare project folder
        run: |
          if [ ! -f "${{ matrix.app }}/pubspec.yaml" ]; then
            echo "Creating Flutter project for ${{ matrix.app }}"
            flutter create ${{ matrix.app }}
          fi

      - name: Copy lib folder if exists
        run: |
          if [ -d "source_code/${{ matrix.app }}/lib" ]; then
            cp -r source_code/${{ matrix.app }}/lib/* ${{ matrix.app }}/lib/
          fi

      - name: Ensure pubspec.yaml has SDK constraint
        run: |
          PUBSPEC="${{ matrix.app }}/pubspec.yaml"
          if ! grep -q "sdk:" $PUBSPEC; then
            echo "environment:\n  sdk: '>=3.1.0 <4.0.0'" >> $PUBSPEC
          fi

      - name: Build IPA
        run: flutter build ios --release --no-codesign
        working-directory: ${{ matrix.app }}

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.app }}_Runner
          path: ${{ matrix.app }}/build/ios/iphoneos/Runner.app
