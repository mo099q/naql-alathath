name: Auto Build Customer App IPA

on:
  push:
    branches: [ main ]

jobs:
  build_customer_app:
    runs-on: macos-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.13.0'

      - name: Prepare Flutter project
        run: |
          # إذا pubspec.yaml غير موجود، أنشئ مشروع Flutter جديد
          if [ ! -f "customer_app/pubspec.yaml" ]; then
            flutter create customer_app
          fi

          # إذا lib موجود في source_code انسخه
          if [ -d "source_code/lib" ]; then
            cp -r source_code/lib/* customer_app/lib/
          fi

          # أضف pubspec.yaml كامل مع SDK constraints
          PUBSPEC="customer_app/pubspec.yaml"
          if ! grep -q "sdk:" $PUBSPEC; then
            echo "environment:\n  sdk: '>=3.1.0 <4.0.0'" > $PUBSPEC
          fi

          # أنشئ Info.plist إذا غير موجود
          if [ ! -f "customer_app/ios/Runner/Info.plist" ]; then
            mkdir -p customer_app/ios/Runner
            cat <<EOT > customer_app/ios/Runner/Info.plist
<?xml version="1.0" encoding="UTF-8"?>
<plist version="1.0">
<dict>
    <key>CFBundleDisplayName</key>
    <string>Naql Alathath</string>
    <key>CFBundleIdentifier</key>
    <string>com.naql.alathath.customer</string>
    <key>NSLocationWhenInUseUsageDescription</key>
    <string>يحتاج التطبيق الوصول لموقعك لتحديد موقعك على الخريطة</string>
    <key>NSLocationAlwaysUsageDescription</key>
    <string>يحتاج التطبيق الوصول لموقعك لتتبع الطلبات أثناء التشغيل</string>
</dict>
</plist>
EOT
          fi

          # أنشئ AppDelegate.swift مع Google Maps API Key
          mkdir -p customer_app/ios/Runner
          cat <<EOT > customer_app/ios/Runner/AppDelegate.swift
import UIKit
import Flutter
import GoogleMaps

@UIApplicationMain
@objc class AppDelegate: FlutterAppDelegate {
  override func application(
    _ application: UIApplication,
    didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?
  ) -> Bool {
    GMSServices.provideAPIKey("AIzaSyBcZ1lyH1hUfV9MRvq-C2xhr4DlfJ5w49o")
    GeneratedPluginRegistrant.register(with: self)
    return super.application(application, didFinishLaunchingWithOptions: launchOptions)
  }
}
EOT

      - name: Get dependencies
        run: flutter pub get
        working-directory: customer_app

      - name: Build IPA
        run: flutter build ios --release --no-codesign
        working-directory: customer_app

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: customer_app_Runner
          path: customer_app/build/ios/iphoneos/Runner.app
